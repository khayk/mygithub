<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Learning JavaScript</title>
</head>
<body>

<script type="text/javascript" src="js/underscore.js"></script>
<script type="text/javascript">

(function() {


   function extend(child, parent) {
      var fnObj = function() {};
      fnObj.prototype = parent.prototype;
      child.prototype = new fnObj();
      child.prototype.constructor = child;
      child.uber = parent.prototype;
   }


   function extend2(Child, Parent) {
      var p = Parent.prototype;
      var c = Child.prototype;
      for (var i in p) {
         c[i] = p[i];
      }
      c.uber = p;
   }


   function extendCopy(p) {
      var c = {};
      for (var i in p) {
         c[i] = p[i];
      }
      c.uber = p;
      return c;
   }

/*
   function deepCopy(p, c) {
      var c = c || {};
      for (var i in p) {
         if (typeof p[i] === 'object') {
            c[i] = (p[i].constructor === Array) ? [] : {}; [] : {};
            deepCopy(p[i], c[i]);
         } else {
            c[i] = p[i]; c[i] = p[i];
         }
      }
      return c;
   }*/


   function object(o) {
      function F() {}
      F.prototype = o;
      return new F();
   }


   function objectEx(o) {
      var n;
      function F() {}
      F.prototype = o;
      n = new F();
      n.uber = o;
      return n;
   }


   // Borrow a constructor and copy the prototype
   function child() {
      parent.apply(this, arguments);
   }
   extend2(child, parent);


// ---------------------------------------------------------------
   // Represents a single verse in a chapter
   function Verse(chapter, number, text, newParagraph) {
      this.parent       = chapter;
      this.number       = number;
      this.text         = text;
      this.newParagraph = newParagraph;
   };

   Verse.prototype = {
      id: function() {
         if (this.parent != null) {
            return this.parent.id() + ':' + this.number;
         }
         return 'null:' + this.number;
      }
   };

   // ---------------------------------------------------------------
   // Represents a chapter in the book
   function Chapter(book, number) {
      this.parent = book;
      this.number = number;
      this.verses = [];

      /// the pair <verse index, heading>, where heading should be displayed
      /// just about the verse with the "verse index"
      this.heading = {};
   }

   Chapter.prototype = {
      id: function() {
         //assert(this.parent);
         return this.parent.id + ' ' + this.number;
      },

      numVerses: function() {
         return _.size(this.verses);
      },

      // Return the verse with specified number
      getVerse: function(number) {
         if (number < 1 || number > this.numVerses())
            throw "Invalid verse number: " + number.toString();
         return this.verses[number - 1];
      }
   }


   // ---------------------------------------------------------------
   // Represents a single book in a bible
   function Book() {
      // reference to parent object (Bible)
      this.parent    = null;
      this.id        = '';
      this.abbr      = '';
      this.name      = '';
      this.desc      = '';
      this.chapters  = [];
   }

   Book.prototype = {
      id: function() {
         return this.id;
      },

      numChapters: function() {
         return _.size(this.chapters);
      },

      // Returns the chapter with given number (not index)
      // null if the chapter with specified number does not exists
      getChapter: function(number) {
         if (number < 1 || number > this.numChapters()) {
            return null;
         }
         return this.chapters[number - 1];
      }
   }



   // Represents a Bible with specified name and language
   function Bible(name, abbr) {
      this.name  = name;
      this.abbr  = abbr;

      this.privateBooks = {};
      // this.books: function() {
      //    var privateBooks = {};
      //    var booksOrder   = {};
      // };
   }

   Bible.prototype = {

      addBook: function(book) {
         this.privateBooks[book.id] = book;
      },

      getBook: function(id) {
         return this.privateBooks[id];
      }
   }




   // ---------------------------------------------------------------
   function ViewOptions() {
      this.viewMode      = null;
      this.font          = null;
      this.paragraphMode = true;

      this.init = function(vm, font, pm) {
         this.viewMode      = vm;
         this.font          = font;
         this.paragraphMode = pm;
      }
   }

   var viewOptions = new ViewOptions();

   // ---------------------------------------------------------------
   function VerseView() {
      this.display = function(verse) {
         return verse.number + '. ' + verse.text;

         // if (viewOptions.paragraphMode === false) {
         //    return verse.number + '. ' + verse.text;
         // }
      }
   }


   // ---------------------------------------------------------------
   function ChapterView(verseView) {
      this.display = function(chapter) {

         var vv = this.verseView;
         var result = '';

         _.each(chapter.verses, function(v) {
            if (result.length != 0)
               result += '\n';
            result += chapter.id();
            result += ':';
            result += vv.display(v);
         });

         return result;
      }
      this.verseView = verseView;
   }

   // ---------------------------------------------------------------
   function BookView(chapterView) {
      this.chapterView = chapterView;

      this.display = function(book) {

         var chapView = this.chapterView;
         _.each(book.chapters, function(c) {
            console.log(chapView.display(c));
         })

         console.log('\n\n');
      }
   }

   function BibleView(bookView) {
      this.bookView = bookView;

      this.display = function(bible) {
         var bookView = this.bookView;
         _.each(bible.privateBooks, function(book) {
            bookView.display(book);
         });
      }
   }

   // the json file path, that describes the content to be loaded
   function loadBible(descFile) {
      //console.log(file + ' is loading...');

      var bible = new Bible();
      bible.name = 'King James Version';
      bible.abbr = 'KJV';

      var bookCfg = [
         {id:'GEN',  name:'Genesis', abbr:'Gen',  numChaps:1, numVerses:1},
         {id:'NUM',  name:'Numbers', abbr:'Num',  numChaps:2, numVerses:2},
         {id:'EXOD', name:'Exodus',  abbr:'Exod', numChaps:3, numVerses:3}
      ];

      for (var i = 0; i < _.size(bookCfg); i += 1) {

         var book  = new Book();
         book.parent = bible;
         book.id   = bookCfg[i].id;
         book.name = bookCfg[i].name;
         book.abbr = bookCfg[i].abbr;

         bible.addBook(book);

         for (var j = 1; j <= bookCfg[i].numChaps; j += 1) {
            var chapter = new Chapter(book, j);

            for (var k = 1; k <= bookCfg[i].numVerses; k += 1) {
               var verse = new Verse(chapter, k, 'verse number ' + k.toString(), false);
               chapter.verses.push(verse);
            }

            book.chapters.push(chapter);
         }
      };

      return bible;
   }


   function scriptEntry() {
      var verseView        = new VerseView();
      var chapterView      = new ChapterView(verseView);
      var bookView         = new BookView(chapterView);
      var bibleView        = new BibleView(bookView);

      viewOptions.init('Web page', 'Arial', true);

      var bible = null;
      for (var i = 0; i < 10; ++i) {
         var b = loadBible('eng');
         bible = b;
      }
      bibleView.display(bible);
   }

   scriptEntry();

}());

</script>
</body>
</html>

